# DRIM-ANN
## Dependency
* The faiss library: integrated to the cluster locating phase on CPU. Install by conda at: https://github.com/facebookresearch/faiss
* UPMEM SDK: please refer to: https://sdk.upmem.com. In case that users have no access to real UPMEM servers, UPMEM SDK provides a simulator for functional verification on CPU. Using the simulator with 64 DPUs allocated at most, please change the parameter `-U` in `Makefile` from `2543` to `64`.

To avoid dependency on faiss, this repo provides a version without faiss as well. You can try this by replacing the folder `host` by `hostNoFaiss`, and replacing `Makefile` by `Makefile.noFaiss`. This version supports hyperthreading and AVX2 by default, and you can change the use of `knn_L2sqr` into `knn_L2sqrAVX512` in `host/tools/src/tools.cpp` and the `CXXFLAGS` in `Makefile.noFaiss` into the annotated one if your machine supports AVX512. However, the implementation has not been deeply optimized, so it is 2~4 times slower than the faiss implementation, especially in cases that `nlist` is large.
## Index & query data
1. Index data example: example index data are provided in the `offlineFiles` folder at https://zenodo.org/records/16752350. Download the whole data folder and move it to the local folder to use them.
2. Query data example: example query data are provided in the `datasets` folder at https://zenodo.org/records/16752350. Download the whole data folder and move it to the local folder to use them.
3. Index data generation: source codes are also provided for index generation in `genOfflineFiles` folder. Note that it would take several hours to generate all indexes of this experiment even with GPU. The `genIndex` folder contains faiss-based implementations for generating centroids, clusters, cluster sizes, and the codebook, which requires prior faiss and cmake installation (use `ln -s ../../faiss faiss` in `genIndex` before using the codes). Other index data including the SQT, cluster layout and some auxiliary data for attempts of cluster-level and vector-level lossless algorithm pruning (though with negligible benefits) can be generated by codes beyond the `genIndex` folder in `../genOfflineFiles` folder. You can compile them with g++-9 (codes in the `genIndex` folder are compiled by cmake instead) and use `-h` parameter to check their usages. Put the generated index data into the `offlineFiles` folder.
## How to test
Make sure that index & query data have been downloaded and placed in this folder. Then execute the following commands:
```
mkdir build
mkdir -p ckpts/SIFT100M
mkdir ckpts/DEEP100M
make run
```
## How to check the results
Check the log and top-k neighbor files in the `build` and `ckpts` folders respectively. Please refer to the Appendix of Artifact Description/Artifact Evaluation of the SC2025 article for more details. For visualization, please use the python script `logVisual.py` like this and check throughput excel/bar-graph results in `Excels` and `Figures` folders respectively:
```
mkdir Excels | mkdir Figures
python logVisual.py --excel-dir-name Excels --diagram-dir-name Figures
```
## Thanks
 * Library of priority queue. The implementations of priority queue in `dpu/libpqueue` in UPMEM_d and UPMEM_h are modified to suit the demands of UPMEM from the implementation here: https://github.com/vy/libpqueue
 * MSR fetching. The implementations of `rdmsr` and related functions in `host/measureEnergy.c` in UPMEM_d and UPMEM_h for energy measurement are modified from the implementation here: https://github.com/lixiaobai09/intel_power_consumption_get/blob/master/powerget.c
 * The basic directory structure of the repo is learned from the upmemGCiM project: https://github.com/KMC20/upmemGCiM
 * The faiss library: https://github.com/facebookresearch/faiss
 * SIFT dataset: http://corpus-texmex.irisa.fr
 * DEEP dataset: https://research.yandex.com/blog/benchmarks-for-billion-scale-similarity-search
## Reference
If you feel this repo is useful for you, don't hesitate to star this!ðŸ˜€ And it is really kind of you to cite this repo in your paper or project.

If you feel DRIM-ANN is interesting, please cite:

```
@inproceedings{10.1145/3712285.3759801,
      author = {Chen, Mingkai and Han, Tianhua and Liu, Cheng and Liang, Shengwen and Yu, Kuai and Dai, Lei and Yuan, Ziming and Wang, Ying and Zhang, Lei and Li, Huawei and Li, Xiaowei},
      title = {DRIM-ANN: An Approximate Nearest Neighbor Search Engine based on Commercial DRAM-PIMs},
      year = {2025},
      isbn = {9798400714665},
      publisher = {Association for Computing Machinery},
      address = {New York, NY, USA},
      url = {https://doi.org/10.1145/3712285.3759801},
      doi = {10.1145/3712285.3759801},
      abstract = {Approximate nearest neighbor search (ANNS) is essential for applications like recommendation systems and retrieval-augmented generation (RAG) but is highly I/O-intensive and memory-demanding. CPUs face I/O bottlenecks, while GPUs are constrained by limited memory. DRAM-based Processing-in-Memory (DRAM-PIM) offers a promising alternative by providing high bandwidth, large memory capacity, and near-data computation. This work introduces DRIM-ANN, the first optimized ANNS engine leveraging UPMEMâ€™s DRAM-PIM. While UPMEM scales memory bandwidth and capacity, it suffers from low computing power because of the limited processor embedded in each DRAM bank. To address this, we systematically optimize ANNS approximation configurations and replace expensive squaring operations with lookup tables to align the computing requirements with UPMEMâ€™s architecture. Additionally, we propose load-balancing and I/O optimization strategies to maximize parallel processing efficiency. Experimental results show that DRIM-ANN achieves a 2.46\texttimes{} speedup over a 32-thread CPU and up to 2.67\texttimes{} over a GPU when deployed on computationally enhanced PIM platforms.},
      booktitle = {Proceedings of the International Conference for High Performance Computing, Networking, Storage and Analysis},
      pages = {820â€“836},
      numpages = {17},
      keywords = {Processing in memory (PIM), DRAM PIM, ANNS, approximate computing},
      location = {
      },
      series = {SC '25}
}
```
or
```
@misc{chen2024drimannapproximatenearestneighbor,
      title={DRIM-ANN: An Approximate Nearest Neighbor Search Engine based on Commercial DRAM-PIMs}, 
      author={Mingkai Chen and Tianhua Han and Cheng Liu and Shengwen Liang and Kuai Yu and Lei Dai and Ziming Yuan and Ying Wang and Lei Zhang and Huawei Li and Xiaowei Li},
      year={2024},
      eprint={2410.15621},
      archivePrefix={arXiv},
      primaryClass={cs.PF},
      url={https://arxiv.org/abs/2410.15621}, 
}
```
